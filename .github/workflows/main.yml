name: Dataiku CI/CD â€“ Dev to Test

on:
  push:
    branches:
      - master

env:
  PROJECT_KEY: DKU_CHURN
  TARGET_ID: Test
  SCENARIO_ID: TEST_SMOKE
  BUNDLE_ID: GitOps-latest

jobs:
  deploy-dataiku:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set bundle ID
        run: echo "BUNDLE_ID=${BUNDLE_PREFIX}-${GITHUB_SHA}" >> $GITHUB_ENV

      # -------------------------------
      # STEP 1: Create bundle
      # -------------------------------
      - name: Create Dataiku bundle
        run: |
          curl -s -X POST \
            "${{ secrets.DESIGN_URL }}/public/api/projects/${{ env.PROJECT_KEY }}/bundles-design/" \
            -H "Authorization: Bearer ${{ secrets.DESIGN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"bundleId\": \"${{ env.BUNDLE_ID }}\",
              \"exportOptions\": {
                \"exportUploads\": true,
                \"exportManagedFS\": true
              }
            }"

      - name: Wait for bundle creation
        run: sleep 15

      # -------------------------------
      # STEP 2: Publish bundle
      # -------------------------------
      - name: Publish bundle to Deployer
        run: |
          curl -s -X POST \
            "${{ secrets.DESIGN_URL }}/public/api/projects/${{ env.PROJECT_KEY }}/bundles-design/${{ env.BUNDLE_ID }}/publish" \
            -H "Authorization: Bearer ${{ secrets.DESIGN_API_KEY }}"

      - name: Wait for publish
        run: sleep 10

      # -------------------------------
      # STEP 3: Deploy to Test
      # -------------------------------
      - name: Deploy bundle to Test
        run: |
          curl -s -X POST \
            "${{ secrets.DEPLOYER_URL }}/public/api/project-deployer/projects/${{ env.PROJECT_KEY }}/deploy" \
            -H "Authorization: Bearer ${{ secrets.DEPLOYER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"bundleId\": \"${{ env.BUNDLE_ID }}\",
              \"deploymentTargetId\": \"${{ env.TARGET_ID }}\"
            }"

      - name: Wait for deployment
        run: sleep 15

      # -------------------------------
      # STEP 4: Run validation scenario
      # -------------------------------
      - name: Run post-deploy scenario
        run: |
          curl -s -X POST \
            "${{ secrets.AUTOMATION_URL }}/public/api/projects/${{ env.PROJECT_KEY }}/scenarios/${{ env.SCENARIO_ID }}/run" \
            -H "Authorization: Bearer ${{ secrets.AUTOMATION_API_KEY }}"
