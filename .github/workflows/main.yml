name: Dataiku Test Deployment

on:
  push:
    branches:
      - master

jobs:
  deploy-bundle:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dataiku-api-client

      - name: Create & Deploy Bundle to Test Environment
        env:
          DESIGN_URL: ${{ secrets.DESIGN_URL }}
          DESIGN_API_KEY: ${{ secrets.DESIGN_API_KEY }}
          DEPLOYER_URL: ${{ secrets.DEPLOYER_URL }}
          DEPLOYER_API_KEY: ${{ secrets.DEPLOYER_API_KEY }}
          DATAIKU_PROJECT_KEY: DKU_CHURN   # ðŸ”´ Replace this
          DATAIKU_INFRA_ID: Test-Environment-automation-node         # ðŸ”´ Replace this
        run: |
          python <<EOF
          import os
          import subprocess
          import dataikuapi

          print("Connecting to Design Node...")

          design_client = dataikuapi.DSSClient(
              os.environ["DESIGN_URL"],
              os.environ["DESIGN_API_KEY"],
              no_check_certificate=True
          )

          print("Connecting to Deployer...")

          deployer_client = dataikuapi.DSSClient(
              os.environ["DEPLOYER_URL"],
              os.environ["DEPLOYER_API_KEY"],
              no_check_certificate=True
          )

          project_key = os.environ["DATAIKU_PROJECT_KEY"]
          infra_id = os.environ["DATAIKU_INFRA_ID"]

          # Generate bundle ID from Git SHA
          sha = subprocess.check_output(
              ["git", "rev-parse", "HEAD"]
          ).decode().strip()

          bundle_id = f"bundle_{sha[:8]}"
          print(f"Creating bundle: {bundle_id}")

          project = design_client.get_project(project_key)

          # Export bundle from Design
          project.export_bundle(bundle_id)
          print("Bundle exported successfully")

          # Publish bundle to Deployer
          project.publish_bundle(bundle_id)
          print("Bundle published to Deployer")

          # Deploy on Deployer
          # deployer = deployer_client.get_projectdeployer()
          # deployment_id = "test-deployment"  # ðŸ”´ change if needed

          # try:
          #     deployment = deployer.get_deployment(deployment_id)
          #     print("Existing deployment found. Updating bundle...")

          #     settings = deployment.get_settings()
          #     settings["bundleId"] = bundle_id
          #     deployment.set_settings(settings)

          # except:
          #     print("Deployment does not exist. Creating new deployment...")

          #     deployment = deployer.create_deployment(
          #         deployment_id=deployment_id,
          #         project_key=project_key,
          #         infra_id=infra_id,
          #         bundle_id=bundle_id
          #     )

          # update = deployment.start_update()
          # result = update.wait_for_result()

          # print("Deployment result:", result)

          # if result.get("state") != "SUCCESS":
          #     raise Exception("Deployment failed")

          # print("âœ… Deployment successful!")
          # EOF

          # Deploy on Deployer
          
          deployer = deployer_client.get_projectdeployer()
          deployment_id = "test-deployment"
          
          try:
              deployment = deployer.get_deployment(deployment_id)
              print("Existing deployment found. Updating bundle...")
          
              settings = deployment.get_settings()
              raw = settings.get_raw()
          
              raw["bundleId"] = bundle_id
          
              settings.set_raw(raw)
              settings.save()
          
              update = deployment.start_update()
          
          except dataikuapi.utils.DataikuException:
              print("Deployment does not exist. Creating new deployment...")
          
              deployment = deployer.create_deployment(
                  deployment_id=deployment_id,
                  project_key=project_key,
                  infra_id=infra_id,
                  bundle_id=bundle_id
              )
          
              update = deployment.start_update()
          
          result = update.wait_for_result()
          
          print("Deployment result:", result)
          
          if result.get("state") != "SUCCESS":
              raise Exception("Deployment failed")
          
          print("âœ… Deployment successful!")
          EOF
